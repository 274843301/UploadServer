<!DOCTYPE html>
<!DOCTYPE html>
<!--[if lte IE 6 ]> <html class="ie ie6 lte_ie7 lte_ie8 lte_ie9" lang="zh-CN"> <![endif]-->
<!--[if IE 7 ]> <html class="ie ie7 lte_ie7 lte_ie8 lte_ie9" lang="zh-CN"> <![endif]-->
<!--[if IE 8 ]> <html class="ie ie8 lte_ie8 lte_ie9" lang="zh-CN"> <![endif]-->
<!--[if IE 9 ]> <html class="ie ie9 lte_ie9" lang="zh-CN"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="zh-CN"> <!--<![endif]-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文件上传服务器-管理页</title>
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
<link rel="stylesheet" type="text/css" href="css/bootstrap-responsive.min.css"/>
<link rel="stylesheet" type="text/css" href="css/style.css"/>
<script language="javascript" type="text/javascript" src="js/jquery-1.12.4.min.js"></script>
<script language="javascript" type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript">

$(document).ready(function (){
    $.get("/getlicense",
    {"time":(new Date()).valueOf()},
    function (data) {
        var lic = $.parseJSON(data);
        if (lic.trial == '1') {
            $('#trial-end-date').html(lic.enddate);
            $('#license-tip').slideToggle(2000);
        }
        else {
            $('#license-tip').remove();
        }
    });
    
    $('#upload-file').click(function (evt) {
        //evt.preventDefault();
        
    });
    
    $('#aboutbox').on('show.bs.modal',function () {
        $aboutbox = $(this);
        $.get("/getlicense",
            {"time":(new Date()).valueOf()},
            function (data) {
            var lic = $.parseJSON(data);
            $aboutbox.find('span.verion').html(lic.ver);
            $aboutbox.find('span.serialno').html(lic.sn);
            if (lic.trial == '1') {
                $aboutbox.find('span.lictype').html('<font color="#f00">试用版</font>&nbsp;截至日期：<font color="#f00">' + lic.enddate + '</font>');
                $aboutbox.find('buttom.btn-primary').show();
            }
            else {
                $aboutbox.find('span.lictype').html('<font color="#00b72e">正式版</font>');
                $aboutbox.find('buttom.btn-primary').hide();
            }
        });
    });
    
    $('#registerbox').on('show.bs.modal',function () {
         $registerbox = $(this);
        
         $.get("/getlicense",
            {"time":(new Date()).valueOf()},
            function (data) {
            var lic = $.parseJSON(data);
                
            $registerbox.find('span.serialno').html(lic.sn);
            if (lic.trial == '1') {
                $registerbox.find('span.lictype').html('<font color="#f00">试用版</font>&nbsp;截至日期：<font color="#f00">' + lic.enddate + '</font>');
                $registerbox.find('buttom.btn-primary').show();
            }
            else {
                $registerbox.find('span.lictype').html('<font color="#00b72e">正式版</font>');
                $registerbox.find('buttom.btn-primary').hide();
            }
         });
    });
});

/*-- toastmessage BEGIN --*/
(function($)
{
	var settings = {
				inEffect: 			{opacity: 'show'},	// in effect
				inEffectDuration: 	600,				// in effect duration in miliseconds
				stayTime: 			3000,				// time in miliseconds before the item has to disappear
				text: 				'',					// content of the item. Might be a string or a jQuery object. Be aware that any jQuery object which is acting as a message will be deleted when the toast is fading away.
				sticky: 			false,				// should the toast item sticky or not?
				type: 				'notice', 			// notice, warning, error, success
                position:           'top-right',        // top-left, top-center, top-right, middle-left, middle-center, middle-right ... Position of the toast container holding different toast. Position can be set only once at the very first call, changing the position after the first call does nothing
                closeText:          '',                 // text which will be shown as close button, set to '' when you want to introduce an image via css
                close:              null                // callback function when the toastmessage is closed
            };

    var methods = {
        init : function(options)
		{
			if (options) {
                $.extend( settings, options );
            }
		},

        showToast : function(options)
		{
			var localSettings = {};
            $.extend(localSettings, settings, options);

			// declare variables
            var toastWrapAll, toastItemOuter, toastItemInner, toastItemClose, toastItemImage;
            var postClass = 'toast-position-' + localSettings.position;
			toastWrapAll = $('body').children('div.toast-container.'+postClass);
			if (!toastWrapAll.length)
				toastWrapAll	= $('<div></div>').addClass('toast-container').addClass(postClass).appendTo('body');
			toastItemOuter	= $('<div></div>').addClass('toast-item-wrapper');
			toastItemInner	= $('<div></div>').hide().addClass('toast-item toast-type-' + localSettings.type).appendTo(toastWrapAll).html($('<p>').append (localSettings.text)).animate(localSettings.inEffect, localSettings.inEffectDuration).wrap(toastItemOuter);
			toastItemClose	= $('<div></div>').addClass('toast-item-close').prependTo(toastItemInner).html(localSettings.closeText).click(function() { $().toastmessage('removeToast',toastItemInner, localSettings) });
			toastItemImage  = $('<div></div>').addClass('toast-item-image').addClass('toast-item-image-' + localSettings.type).prependTo(toastItemInner);

            if (localSettings.position.substr(0,9) == "relative-") {
                var posLeft = 0,posTop = 0;
                var parentElm = $('#'+localSettings.position.substr(9));
                if (parentElm.length>0) {
                    var X = parentElm.offset().top;
                    var Y = parentElm.offset().left;
                    
                    posLeft = X + Math.round((parentElm.width() - toastWrapAll.width()) / 2);
                    posTop = Y + Math.round((parentElm.height() - toastWrapAll.height()) / 2);
                }
                
                toastWrapAll.css({"position":"fixed","left":posLeft+'px',"top":posTop+'px'});
            }
            
            if(navigator.userAgent.match(/MSIE 6/i))
			{
		    	toastWrapAll.css({top: document.documentElement.scrollTop});
		    }

			if(!localSettings.sticky)
			{
				setTimeout(function(){
					$().toastmessage('removeToast', toastItemInner, localSettings);
				},localSettings.stayTime);
			}
            return toastItemInner;
		},

        showNoticeToast : function (message)
        {
            var options = {text : message, type : 'notice'};
            return $().toastmessage('showToast', options);
        },

        showSuccessToast : function (message)
        {
            var options = {text : message, type : 'success'};
            return $().toastmessage('showToast', options);
        },

        showErrorToast : function (message)
        {
            var options = {text : message, type : 'error'};
            return $().toastmessage('showToast', options);
        },

        showWarningToast : function (message)
        {
            var options = {text : message, type : 'warning'};
            return $().toastmessage('showToast', options);
        },

		removeToast: function(obj, options)
		{
			obj.animate({opacity: '0'}, 600, function()
			{
				obj.parent().animate({height: '0px'}, 300, function()
				{
					obj.parent().remove();
				});
			});
            // callback
            if (options && options.close !== null)
            {
                options.close();
            }
		}
	};

    $.fn.toastmessage = function( method ) {

        // Method calling logic
        if ( methods[method] ) {
          return methods[ method ].apply( this, Array.prototype.slice.call( arguments, 1 ));
        } else if ( typeof method === 'object' || ! method ) {
          return methods.init.apply( this, arguments );
        } else {
          $.error( 'Method ' +  method + ' does not exist on jQuery.toastmessage' );
        }
    };

})(jQuery);

/*-- toastmessage END --*/

function aboutToRegister() {
    $('#aboutbox').modal('hide');
    $('#registerbox').modal('show');
}

function onLicFileChange(fileobj) {
    var addEvent = function (obj,type,handle){
    try{ // Chrome、FireFox、Opera、Safari、IE9.0及其以上版本
      obj.addEventListener(type,handle,false);
      }catch(e){
      try{ // IE8.0
        obj.attachEvent('on' + type,handle);
        }catch(e){ 
        obj['on' + type] = handle;
      }
    }
  }
  
  var myForm = fileobj.form;
  var fileUploadFrame = document.getElementById("iframe-upload-target");
  
  fileUploadFrame.name = "iframe-upload-target";
  fileUploadFrame.contentWindow.name = "iframe-upload-target";
  
  if (!fileUploadFrame.getAttribute('load-event')) {
      addEvent(fileUploadFrame,'load',function () {
        var result;
        
        var _this = this;
        var iframe = fileUploadFrame;
  
        var doc = iframe.contentDocument || iframe.contentWindow.document;
        //alert(doc.body.innerText);
        myForm.reset();

        var $registerbox = $('#registerbox');
        
        var lic = $.parseJSON(doc.body.innerText);
            
        if (lic.error) {
            var msg;
            var flags = lic.code;
            if (flags == 0)
                msg = "许可证装入错误，可能不是正确的许可证文件！";
            else if (flags == 1) 
                msg = "许可证的产品类型不符合！";
            else if (flags == 2) 
                msg = "许可证文件更新错误，也许没有正确的权限。";
            else if (flags == 3) 
                msg = "许可证文件刷新错误，也许没有文件操作权限。";
            else if (flags == 4) 
                msg = "许可证文件校验失败，不是合法的许可证文件。";
            else
                msg = "导入许可证发生未知错误。";
            
            $().toastmessage('showToast', {
                text     : "更新许可证出现错误。<br/>错误原因：<br/>"+msg+"<br/>",
                sticky   : false,
                stayTime : 6000,
                position : 'top-center',
                type     : 'error',
                close    : function () { /*console.log("toast is closed ...");*/}
            });
        }
        else {
            $registerbox.find('span.serialno').html(lic.sn);
            if (lic.trial == '1') {
                $registerbox.find('span.lictype').html('<font color="#f00">试用版</font>&nbsp;截至日期：<font color="#f00">' + lic.enddate + '</font>');
                $registerbox.find('buttom.btn-primary').show();
            }
            else {
                $registerbox.find('span.lictype').html('<font color="#00b72e">正式版</font>');
                $registerbox.find('buttom.btn-primary').hide();
            }
            
            $().toastmessage('showToast', {
                text     : "导入许可证成功！<br/>",
                sticky   : false,
                stayTime : 3000,
                position : 'top-center',
                type     : 'success',
                close    : function () { /*console.log("toast is closed ...");*/}
            });
        }
      });
      fileUploadFrame.setAttribute('load-event','true');
  }
   
  //myForm.action="/register?time=" + (new Date()).valueOf();
  myForm.submit();
}
</script>
</head>
<body>

<div class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
    <div class="container-fluid">
      <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="brand" href="#">文件上传服务</span>
      <div class="nav-collapse collapse">
        <ul class="nav">
          <li class="active"><a id="showaboutbox" href="#aboutbox" role="button" data-toggle="modal">关于</a></li>
          <li><a href="#registerbox" role="button" data-toggle="modal">注册</a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
    </div>
</div>
    
<div class="container-fluid wrap">
  <div class="row-fluid" >
    <div class="control-wrap">
		<a href="upload.html" class="btn btn-center" id="upload-file">上传文件</a>
	</div>
  </div>
  <div class="row-fluid" >
    &nbsp;
  </div>
  <div class="row-fluid" id="license-tip" style="display:none">
     <div class="control-wrap">
       <div class="alert alert-block">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          <h4>温馨提示：</h4>
          <span>当前产品为非正式版或者您还没有用许可证书注册产品，请注册产品以便更好地为您服务。</span>
          <br/>
          <span>试用结束日期:&nbsp;</span><span id="trial-end-date" style="color:#f00">1999-01-01</span>
       </div>
    </div>
    <div class="control-wrap">
		<a href="#registerbox" class="btn btn-center" role="button" data-toggle="modal">注册许可证</a>
	</div>
  </div>
</div>

<!-- Modal -->
<div id="aboutbox" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <div id="myModalLabel" class="dlg-captionbar"><span class="dlg-caption">关于</span><button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-remove"></i></button></div>
  </div>
  <div class="modal-body">
    <p>Web 文件上传服务器</p>
    <p><span class="label-title">版本：</span><span class="verion">1.0 (2017)</span></p>
    <p><span class="label-title">序列号：</span><span class="serialno">AC11-KSBV-CCSC-DSCV-VBSS</span></p>
    <p><span class="label-title">许可证：</span><span class="lictype">已经授权</span></p>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">&nbsp;关闭&nbsp;</button>
    <button class="btn btn-primary" onclick="aboutToRegister();">注册许可证</button>
  </div>
</div>
 
<div id="registerbox" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <div id="myModalLabel" class="dlg-captionbar"><span class="dlg-caption">产品注册</span><button type="button" class="close" data-dismiss="modal" aria-hidden="true"><i class="icon-remove"></i></button></div>
  </div>
  <div class="modal-body">
    <p><span class="label-title">序列号：</span><span class="serialno">AC11-KSBV-CCSC-DSCV-VBSS</span></p>
    <p><span class="label-title">许可证：</span><span class="lictype">试用版</span></p>
    <p class="note-title">注册提示：</p>
    <p>要注册本产品，请将以上序列号发送给软件生产商后向软件生产商取得许可证书，再将软件生产商生成的许可证书文件导入到本系统即可。</p>
    <p>如果已经导入许可证，也可以继续导入新的许可证。</p>
    <div class="row-fluid" >
      <form action="/register" method="post" enctype="multipart/form-data" name="regform" data-form="regform" target="iframe-upload-target">
      <input name="filecount" type="hidden" value="1">
      <input name="uploadway" type="hidden" value="iframe">
      <div class="file-wrap">
        <div class="file-browser">导入许可证文件</div>
        <input type="file" class="fileobj" name="file" id="fileobj" onchange="onLicFileChange(this);" accept="text/lic,application/lic">
      </div>
      </form>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn" data-dismiss="modal" aria-hidden="true">&nbsp;关闭&nbsp;</button>
  </div>
</div>
<iframe src="about:blank" width="1" height="1" style="display:none" name="iframe-upload-target" id="iframe-upload-target"></iframe>
</body>
</html>